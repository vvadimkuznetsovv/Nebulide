FROM lscr.io/linuxserver/code-server:latest

# sudo for user abc (linuxserver.io default uid=1000)
RUN apt-get update && apt-get install -y sudo && \
    echo "abc ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Node.js 20 (required for Claude Code CLI)
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && \
    apt-get install -y nodejs && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Claude Code CLI
RUN npm install -g @anthropic-ai/claude-code

# Disable code-server password auth on every container start.
# Clauder's JWT reverse proxy (/code/*) handles all authentication.
# Without this, code-server generates a random password and blocks all requests.
RUN mkdir -p /custom-cont-init.d && \
    printf '%s\n' \
        '#!/bin/bash' \
        'mkdir -p /config/.config/code-server' \
        'printf "bind-addr: 0.0.0.0:8443\nauth: none\ncert: false\n" > /config/.config/code-server/config.yaml' \
        '' \
        '# VS Code settings â€” compact Activity Bar on top' \
        'mkdir -p /config/data/User' \
        'cat > /config/data/User/settings.json << '\''SETTINGS'\''' \
        '{' \
        '  "workbench.activityBar.location": "top",' \
        '  "window.menuBarVisibility": "compact",' \
        '  "workbench.colorTheme": "Visual Studio Dark - C++",' \
        '  "claudeCode.selectedModel": "opus"' \
        '}' \
        'SETTINGS' \
        '' \
        '# Install extensions: C++ themes (Visual Studio Dark - C++) + Claude Code' \
        '/app/code-server/bin/code-server --extensions-dir /config/extensions --install-extension ms-vscode.cpptools-themes --force 2>/dev/null' \
        '/app/code-server/bin/code-server --extensions-dir /config/extensions --install-extension anthropic.claude-code --force 2>/dev/null &' \
        > /custom-cont-init.d/50-disable-auth && \
    chmod +x /custom-cont-init.d/50-disable-auth
